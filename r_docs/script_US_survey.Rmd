---
title: "script_US_survey"
author: "CH"
date: "28/11/2020"
output: html_document
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
# packages
library(here) # find relative path
library(readr) # read dataset
library(tidyverse) 
library(dplyr) 
library(remotes)
library(Routliers) # outlier detection
library(psych) # normality, reliability
library(lavaan)
library(ggplot2)

# dataset
data <- here::here("data/US_data.csv")
US_data <- readr::read_csv(data) %>%
  as_tibble() 
US_data$time <- factor(US_data$time)
US_data$vote <- factor(US_data$vote)
US_data$unexp <- factor(US_data$unexp)
```

# Data inspection

```{r boxplots, include=TRUE}

# cn
box_cn_1 <- boxplot(US_data$cn_1)
box_cn_2 <- boxplot (US_data$cn_2)
box_cn_3 <- boxplot(US_data$cn_3)
box_cn_4 <- boxplot(US_data$cn_4)
box_cn_5 <- boxplot(US_data$cn_5)
# 1 outlier in cn_1

# secident
box_secident_1 <- boxplot(US_data$secident_1)
box_secident_2 <- boxplot(US_data$secident_2)
box_secident_3 <- boxplot(US_data$secident_3)
box_secident_4 <- boxplot(US_data$secident_4)
box_secident_5 <- boxplot(US_data$secident_5)
box_secident_6 <- boxplot(US_data$secident_6)
box_secident_7 <- boxplot(US_data$secident_7)
box_secident_8 <- boxplot(US_data$secident_8)
box_secident_9 <- boxplot(US_data$secident_9)
box_secident_10 <- boxplot(US_data$secident_10)
# Striking is that items secident _7 to _10 show the same boxplot. I checked the raw data to make sure that the values were not accidently doublicated and copy-pasted but the items are unique in values, yet similar to each other in expression. Potentially colinear?

# xeno
box_xeno_1 <- boxplot(US_data$xeno_1)
box_xeno_2 <- boxplot(US_data$xeno_2)
box_xeno_3 <- boxplot(US_data$xeno_3)
box_xeno_4 <- boxplot(US_data$xeno_4)
box_xeno_5 <- boxplot(US_data$xeno_5)
box_xeno_6 <- boxplot(US_data$xeno_6)
# 1 outlier in xeno_1, 1 in xeno_2, 3 in xeno_3

# joy
box_joy_1 <- boxplot(US_data$joy_1)
box_joy_2 <- boxplot(US_data$joy_2)

# eff
box_eff_1 <- boxplot(US_data$eff_1)
box_eff_2 <- boxplot(US_data$eff_2)
# 1 outlier in eff_1
```

```{r histograms, include=TRUE}
# cn 
ggplot(US_data, aes(x=cn_1))+
  stat_bin(colour="grey",fill="steelblue", geom = "bar") +
  labs(x = "CN", y = "Frequency")

ggplot(US_data, aes(x=cn_2))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=cn_3))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=cn_4))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=cn_5))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")


# xeno 
ggplot(US_data, aes(x=xeno_1))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=xeno_2))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=xeno_3))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=xeno_4))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=xeno_5))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=xeno_6))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")


# secident
ggplot(US_data, aes(x=secident_1))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=secident_2))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=secident_3))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=secident_4))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=secident_5))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=secident_6))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=secident_7))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=secident_8))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=secident_9))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=secident_10))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")


# joy
ggplot(US_data, aes(x=joy_1))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=joy_2))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")


# eff
ggplot(US_data, aes(x=eff_1))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")

ggplot(US_data, aes(x=eff_2))+
  stat_bin(colour="black",fill="darkgreen", geom = "bar")
```

```{r histograms by group, include=TRUE}

# cn by vote
ggplot(US_data, aes(x=cn_1, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=cn_2, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=cn_3, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=cn_4, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=cn_5, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

# cn by time
ggplot(US_data, aes(x=cn_1, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=cn_2, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=cn_3, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=cn_4, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=cn_5, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

# xeno by vote
ggplot(US_data, aes(x=xeno_1, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=xeno_2, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=xeno_3, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=xeno_4, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=xeno_5, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=xeno_6, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")


# xeno by time
ggplot(US_data, aes(x=xeno_1, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=xeno_2, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=xeno_3, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=xeno_4, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=xeno_5, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=xeno_6, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")


# secident by vote
ggplot(US_data, aes(x=secident_1, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_2, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_3, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_4, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_5, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_6, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_7, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_8, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_9, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_10, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")


# secident by time
ggplot(US_data, aes(x=secident_1, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_2, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_3, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_4, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_5, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_6, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_7, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_8, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_9, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=secident_10, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")


# joy by vote
ggplot(US_data, aes(x=joy_1, fill= vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=joy_2, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")


# joy by time
ggplot(US_data, aes(x=joy_1, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=joy_2, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")


# eff by vote
ggplot(US_data, aes(x=eff_1, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=eff_2, fill=vote))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

# eff by time
ggplot(US_data, aes(x=eff_1, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")

ggplot(US_data, aes(x=eff_2, fill=time))+
  geom_histogram(aes(y=..density..),binwidth=1, alpha=.5, position="identity")
```


```{r outlier detection using MAD, include = TRUE}

# cn
cn <- rowMeans(US_data[, c("cn_1", "cn_2", "cn_3", "cn_4", "cn_5")])
cn_mad <- outliers_mad(x = cn)
cn_mad
# no outliers detected

# secident
secident <- rowMeans(US_data[, c("secident_1", "secident_2", "secident_3", "secident_4", "secident_5", "secident_6", "secident_7", "secident_8", "secident_9", "secident_10")])
secident_mad <- outliers_mad(x = secident)
secident_mad
# no outliers detected

# xeno
xeno <- rowMeans(US_data[, c("xeno_1", "xeno_2", "xeno_3", "xeno_4", "xeno_5", "xeno_6")])
xeno_mad <- outliers_mad(x = xeno)
xeno_mad
plot_outliers_mad(xeno_mad, x = xeno, pos_display = TRUE)
# 6 outliers detected: the value of 2.8926 was compared with the median of xeno_1 - xeno_6 in dataset and the following ids were identified as > 2.8926: p090 (t1), p189, p192 (t2), p196

# joy
joy <- rowMeans(US_data[, c("joy_1", "joy_2")])
joy_mad <- outliers_mad(x = joy)
joy_mad
# no outliers detected

# eff
eff <- rowMeans(US_data[, c("eff_1", "eff_2")])
eff_mad <- outliers_mad(x = eff)
eff_mad
# no outliers detected
```


# reliability (internal consistency)

```{r, reliability, include=TRUE}
# cn
key <- list(
  CN = c("cn_1", "cn_2", "cn_3", "cn_4", "cn_5")
)

# Cronbach´s alpha
scoreItems(key, US_data)

# Reliability if item is dropped (--> raw alpha)

US_data %>%
  select(5:9) %>%
  psych::alpha()

# cronbach´s alpha for cn = 0.84


# secident
key <- list(
  secident = c("secident_1", "secident_2", "secident_3", "secident_4", "secident_5", 
               "secident_6", "secident_7", "secident_8", "secident_9", "secident_10")
)

# Cronbach´s alpha
scoreItems(key, US_data)

# Reliability if item is dropped (--> raw alpha)

US_data %>%
  select(16:25) %>%
  psych::alpha()

# cronbach´s alpha for secident = 0.96

# xeno
key <- list(
  xeno = c("xeno_1", "xeno_2", "xeno_3", "xeno_4", "xeno_5", "xeno_6")
)

# Cronbach´s alpha
scoreItems(key, US_data)

# Reliability if item is dropped (--> raw alpha)

US_data %>%
  select(10:15) %>%
  psych::alpha()

# cronbach´s alpha for xeno = 0.71

# joy
key <- list(
  joy = c("joy_1", "joy_2")
)

# Cronbach´s alpha
scoreItems(key, US_data)

# Reliability if item is dropped (--> raw alpha)

US_data %>%
  select(35:36) %>%
  psych::alpha()

# cronbach´s alpha for joy = 0.81

# eff
key <- list(
  eff = c("eff_1", "eff_2")
)

# Cronbach´s alpha
scoreItems(key, US_data)

# Reliability if item is dropped (--> raw alpha)

US_data %>%
  select(37:38) %>%
  psych::alpha()

# cronbach´s alpha for eff = 0.81
```

# normality test for those items, a normal distribution is expected (use ML estimation, for those items no normal distribution is expected (xenophobia), use MLR in CFA

# action required if skewness > 2, kurtosis > 7, multivariate kurtosis (Mardia´s coefficient) > 3
# psych package: describe() --> skew and kurtosis, mardia ()

```{r}

```


# validity (CFA) based on items that were chosen to be kept
# data has to be data matrix

```{r, cfa, include=TRUE}
# cn
cn.model <- 'CollectNar =~ cn_1 + cn_2 + cn_3 + cn_4 + cn_5'

# fit the model

fit_cn <- cfa(cn.model, data = US_data, estimator = "ML")

# Check the results, quick check with "User Model versus
# Baseline Model," which should have values above 0.9 or
# possibly 0.95

fit_cn %>% summary(fit.measures = TRUE)

# xeno

xeno.model <- 'Xenophobia =~ xeno_1 + xeno_2 + xeno_3 + xeno_4 + 
xeno_5 + xeno_6'

# fit the model

fit_xeno <- cfa(xeno.model, data = US_data, estimator = "MLR")

# Check the results, quick check with "User Model versus
# Baseline Model," which should have values above 0.9 or
# possibly 0.95

fit_xeno %>% summary(fit.measures = TRUE)

# secident is multidimensional

sec.model <- 'satisfac =~ secident_4 + secident_5 + secident_6 + secident_7 
              solidar =~ secident_1 + secident_2 + secident_3 
              central  =~ secident_8 + secident_9 + secident_10'
fit_secident <- cfa(sec.model, data = US_data, estimator = "ML")
fit_secident %>% summary(fit.measures = TRUE)
```

# creating new variables (cn, secident, xeno, joy & eff)
```{r, new variables, include=TRUE}
US_data1 <- US_data %>%
  mutate(cn = (cn_1 + cn_2 + cn_3 + cn_4 + cn_5)/5,
        secident = (secident_1 + secident_2 + secident_3 + secident_4 + secident_5 +
        secident_6 + secident_7 + secident_8 + secident_9 + secident_10)/10,
        xeno = (xeno_1 + xeno_2 + xeno_3 + xeno_4 + xeno_5 + xeno_6)/6, # depending on cfa, not all items will be considered here
        joy = (joy_1 + joy_2)/2,
        eff = (eff_1 + eff_2)/2)
```

# assumption checks for PI, FC & corona (do not sum!) items

```{r, assumption checks PI, FC, corona}

```

# descriptive statistics

```{r, frequencies}
US_data %>% 
  select(vote) %>%
  table()
```

```{r, continous, grouped}

```


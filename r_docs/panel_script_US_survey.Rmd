---
title: "panel_US_survey"
author: "CH"
date: "30/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyverse)
library(dplyr)
library(QuantPsyc) 
library(plm) # panel for regression
library(lmtest)
library(pglm) # panel logistic regression
library(pscl)

data <- here::here("data/US_data.csv")
US_data <- readr::read_csv(data) %>%
  as.data.frame()

US_data <- US_data %>%
  mutate(vote = case_when(
  vote=='1' ~ 'Democrats',
  vote=='2' ~ 'Republicans',
  TRUE ~ 'Other'))

US_data <- US_data %>%
  mutate(unexp = case_when(
    unexp == "0" ~ "Expected",
    unexp == "1" ~ "Unexpected",
    unexp == "2" ~ "Neither expected nor unexpected"))

US_data <- US_data %>%
  mutate(gend = case_when(
    gend == "1" ~ "Female",
    gend == "2" ~ "Male",
    gend == "3" ~ "Non-binary"
  ))

US_data <- US_data %>%
  mutate(ethn = case_when(
    ethn == "1" ~ "Asian-American",
    ethn == "2" ~ "Black or African American",
    ethn == "3" ~ "Hispanic or Latino American",
    ethn == "4" ~ "Native American",
    ethn == "5" ~ "White or European American",
    ethn == "6" ~ "Other"
  ))

US_data <- US_data %>%
  mutate(degree =case_when(
    degree == "1" ~ "No degree",
    degree == "2" ~ "High School",
    degree == "3" ~ "Bachelor´s degree",
    degree == "4" ~ "Master´s degree",
    degree == "5" ~ "Doctoral degree",
    degree == "6" ~ "Professional degree",
    degree == "7" ~ "Other"
  ))

US_data <- US_data %>%
  mutate(employ = case_when(
    employ == "1" ~ "Working - paid employee",
    employ == "2" ~ "Working - self-employed",
    employ == "3" ~ "Not working - temporary layoff from a job",
    employ == "4" ~ "Not working - looking for a job",
    employ == "5" ~ "Not working - retired",
    employ == "6" ~ "Not working - disabled",
    employ == "7" ~ "Not working - student",
    employ == "8" ~ "Other"
  ))

US_data <- US_data %>%
  mutate(income = case_when(
    income == "1" ~ "$0 - $10,000",
    income == "2" ~ "$10,000 - $20,000",
    income == "3" ~ "$20,000 - $30,000",
    income == "4" ~ "$30,000 - $40,000",
    income == "5" ~ "$40,000 - $50,000",
    income == "6" ~ "over $50,000"
  ))

# computing new variables and z-scores
US <- US_data %>%
  mutate(cn = (cn_1 + cn_2 + cn_3 + cn_4 + cn_5)/5,
        secident = (secident_1 + secident_2 + secident_3 + secident_4 + secident_5 +
        secident_6 + secident_7 + secident_8 + secident_9 + secident_10)/10,
        ingroup_satis = (secident_4 + secident_5 + secident_6 + secident_7)/4,
        xeno = (xeno_1 + xeno_2 + xeno_3 + xeno_4)/4, 
        joy = (joy_1 + joy_2)/2,
        eff = (eff_1 + eff_2)/2) %>%
    mutate(z_cn = (cn - (mean(cn)/ sd(cn))),
         z_secident = (secident - (mean(secident)/ sd(secident))),
         z_fc_1_o_agr = (fc_1_o_agr - (mean(fc_1_o_agr) / sd(fc_1_o_agr))),
         z_fc_2_o_agr = (fc_2_o_agr -(mean (fc_2_o_agr)/ sd(fc_2_o_agr))),
         z_sd = (sd - (mean(sd)/ sd(sd))),
         z_cor_health = (cor_health - (mean(cor_health) / sd(cor_health))),
         z_cor_values = (cor_values - (mean(cor_values)/sd(cor_values))),
         z_joy = (joy - (mean(joy)/ sd(joy))),
         z_eff = (eff - (mean(eff) / sd(eff))),
         z_share = (share - (mean(share)/ sd(share))),
         z_donate = (donate - (mean(donate)/ sd(donate)))) %>%
  as.data.frame()
US

US$id <- as.factor(US$id)
US$time <- as.factor(US$time)

# subset data
US_t1_mod <- subset(US, time == "1" & vote == "Republicans" & unexp == "Unexpected")
US_t2_mod <- subset(US, time == "2" & vote == "Republicans" & unexp == "Unexpected")

US_t1_mod$id <- as.factor(US_t1_mod$id)
US_t1_mod$time <- as.factor(US_t1_mod$time)
US_t1_mod$vote <- as.factor(US_t1_mod$vote)

US_t2_mod$id <- as.factor(US_t2_mod$id)
US_t2_mod$time <- as.factor(US_t2_mod$time)
US_t2_mod$vote <- as.factor(US_t2_mod$vote)
```

# panel design regression
```{r}
is.data.frame(US)
dim(US)
str(US)
summary(US)

# computing differences in fc_1_o_agr and cn
diff_z_fc_1_o_agr <- US_t2_mod$z_fc_1_o_agr - US_t1_mod$z_fc_1_o_agr
diff_z_fc_2_o_agr <- US_t2_mod$z_fc_2_o_agr - US_t1_mod$z_fc_2_o_agr
diff_z_secident <- US_t2_mod$z_secident - US_t1_mod$z_secident
diff_z_cn <- US_t2_mod$z_cn - US_t1_mod$z_cn
diff_z_sd <- US_t2_mod$z_sd - US_t1_mod$z_sd
diff_z_cor_values <- US_t2_mod$z_cor_values - US_t1_mod$z_cor_values
diff_z_cor_health <- US_t2_mod$z_cor_health - US_t1_mod$z_cor_health
diff_z_joy <- US_t2_mod$z_joy - US_t1_mod$z_joy
diff_z_eff <- US_t2_mod$z_eff - US_t1_mod$z_eff
diff_sign <- US_t2_mod$sign - US_t1_mod$sign
diff_z_share <- US_t2_mod$z_share - US_t1_mod$z_share
diff_z_donate <- US_t2_mod$z_donate - US_t1_mod$z_donate

# regression fc_1_o_agr (step 1)
diff_Z_fc_1 <- lm(diff_z_fc_1_o_agr ~ diff_z_cn)
coeftest(diff_Z_fc_1, vcov = vcovHC, type = "HC1")
summary(diff_Z_fc_1)

diff_z_fc_1alt <- lm(diff_z_fc_1_o_agr ~  diff_z_sd + diff_z_cor_values + diff_z_cor_health + diff_z_secident + diff_z_cn)
coeftest(diff_z_fc_1alt, vcov = vcovHC, type = "HC1")
confint(diff_z_fc_1alt)
summary(diff_z_fc_1alt)
plot(diff_z_fc_1alt)

# fixed effect regression fc_1_o_agr, keeping effects across entities constant (step 2)
diff_z_fc_12 <- plm(z_fc_1_o_agr ~ z_cn + id, 
                   data = US,
                   index = c("id", "time"),
                   model = "within")
coeftest(diff_z_fc_12, vcov = vcovHC, type = "HC1")
r.squared(diff_z_fc_12)

# time fixed effect regression fc_1_o_agr, keeping effects across entities and time constant (step 3)
diff_z_fc_13 <- plm(z_fc_1_o_agr ~ z_sd + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_fc_13, vcov = vcovHC, type = "HC1")
r.squared(diff_z_fc_13)

# adding control variables

diff_z_fc_14 <- plm(z_fc_1_o_agr ~ z_sd + z_cor_values + z_cor_health + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_fc_14, vcov = vcovHC, type = "HC1")
r.squared(diff_z_fc_14)

diff_z_fc_15 <- plm(z_fc_1_o_agr ~ z_sd + z_cor_values + z_cor_health + z_secident + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_fc_15, vcov = vcovHC, type = "HC1")
r.squared(diff_z_fc_15)

diff_z_fc_16 <- plm(z_fc_1_o_agr ~ z_sd + z_cor_values + z_cor_health + z_secident + z_cn + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_fc_16, vcov = vcovHC, type = "HC1")
r.squared(diff_z_fc_16)

diff_z_fc_17 <- plm(z_fc_1_o_agr ~ z_secident + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_fc_17, vcov = vcovHC, type = "HC1")
r.squared(diff_z_fc_17)

diff_z_fc_18 <- plm(z_fc_1_o_agr ~ z_secident + z_cn + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(z_diff_fc_18, vcov = vcovHC, type = "HC1")
r.squared(z_diff_fc_18)


# regression fc_2_o_agr (step 1)
diff_z_fc_2 <- lm(diff_z_fc_2_o_agr ~ diff_z_cn)
coeftest(diff_z_fc_2, vcov = vcovHC, type = "HC1")
summary(diff_z_fc_2)

diff_z_fc_2alt <- lm(diff_z_fc_2_o_agr ~  diff_z_sd + diff_z_cor_values + diff_z_cor_health+ diff_z_cn + diff_z_secident)
coeftest(diff_z_fc_2alt, vcov = vcovHC, type = "HC1")
confint(diff_z_fc_2alt)
summary(diff_z_fc_2alt)

# fixed effect regression fc_2_o_agr, keeping effects across entities constant (step 2)
diff_z_fc_22<- plm(z_fc_2_o_agr ~ z_cn + id, 
                   data = US,
                   index = c("id", "time"),
                   model = "within")
coeftest(diff_z_fc_22, vcov = vcovHC, type = "HC1")
r.squared(diff_z_fc_22)

# time fixed effect regression fc_2_o_agr, keeping effects across entities and time constant (step 3)
diff_z_fc_23 <- plm(z_fc_2_o_agr ~ z_sd + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_fc_23, vcov = vcovHC, type = "HC1")
r.squared(diff_z_fc_23)

# adding control variables
diff_z_fc_24 <- plm(z_fc_2_o_agr ~ z_sd + z_cor_values + z_cor_health + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_fc_24, vcov = vcovHC, type = "HC1")
r.squared(diff_z_fc_24)

diff_z_fc_25 <- plm(z_fc_2_o_agr ~ z_sd + z_cor_values + z_cor_health + z_secident + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_fc_25, vcov = vcovHC, type = "HC1")
r.squared(diff_z_fc_25)

diff_z_fc_26 <- plm(z_fc_2_o_agr ~ z_sd + z_cor_values + z_cor_health + z_secident + z_cn + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_fc_26, vcov = vcovHC, type = "HC1")
r.squared(diff_z_fc_26)

diff_z_fc_27 <- plm(z_fc_2_o_agr ~ z_secident + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_fc_27, vcov = vcovHC, type = "HC1")
r.squared(diff_z_fc_27)

diff_z_fc_28 <- plm(z_fc_2_o_agr ~ z_secident + z_cn + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_fc_28, vcov = vcovHC, type = "HC1")
r.squared(diff_z_fc_28)


# logistic regression
US_panel <- pdata.frame(US, index = c("id", "time"))
sign.mod <- pglm(sign ~ sd, 
             data = US_panel,
             family = binomial(link = "logit"))
summary(sign.mod)

sign.mod2 <- pglm(sign ~ sd + cor_values + cor_health, 
             data = US_panel,
             family = binomial(link = "logit"))
summary(sign.mod2)

sign.mod3 <- pglm(sign ~ sd + cor_values + cor_health + secident, 
             data = US_panel,
             family = binomial(link = "logit"))
summary(sign.mod3)

sign.mod4 <- pglm(sign ~ sd + cor_values + cor_health + secident + cn, 
             data = US_panel,
             family = binomial(link = "logit"))
summary(sign.mod4)
exp(coef(sign.mod4))
exp(confint(sign.mod4))
```

# False consensus and empowerment
```{r}
# subset for fc_1_o_agr on joy
US_t1_mod <- subset(US, time == "1" & vote == "Republicans" & unexp == "Unexpected" & id!= "p053" & id!= "p153" & id!= "p159" & id!= "p180" & id!= "p197")
US_t2_mod <- subset(US, time == "2" & vote == "Republicans" & unexp == "Unexpected" & id!= "p053" & id!= "p153" & id!= "p159" & id!= "p180" & id!= "p197")

# subset for fc_2_o_agr on joy
US_t1_mod <- subset(US, time == "1" & vote == "Republicans" & unexp == "Unexpected" & id!= "p053" & id!= "p153" & id!= "p197")
US_t2_mod <- subset(US, time == "2" & vote == "Republicans" & unexp == "Unexpected" & id!= "p053" & id!= "p153" & id!= "p197")

# subset for fc_1_o_agr on eff
US_t1_mod <- subset(US, time == "1" & vote == "Republicans" & unexp == "Unexpected" & id!= "p024" & id!= "p028" & id!= "p049" & id!= "p073" & id!= "p085" & id!= "p136" & id!= "p180")
US_t2_mod <- subset(US, time == "2" & vote == "Republicans" & unexp == "Unexpected" & id!= "p024" & id!= "p028" & id!= "p049" & id!= "p073" & id!= "p085" & id!= "p136" & id!= "p180")

# subset for fc_2_o_agr on eff
US_t1_mod <- subset(US, time == "1" & vote == "Republicans" & unexp == "Unexpected" & id!= "p024" & id!= "p049" & id!= "p073" & id!= "p085" & id!= "p196")
US_t2_mod <- subset(US, time == "2" & vote == "Republicans" & unexp == "Unexpected" & id!= "p024" & id!= "p049" & id!= "p073" & id!= "p085" & id!= "p196")

# False consensus, empowerment and behavioural intention 
# regression joy & eff (step 1)
# joy by fc_1_o_agr
diff_z_joy.mod <- lm(diff_z_joy ~ diff_z_fc_1_o_agr)
coeftest(diff_z_joy.mod, vcov = vcovHC, type = "HC1")
summary(diff_z_joy.mod)
confint(diff_z_joy.mod)
plot(diff_z_joy.mod)

# after removing outlier "p053", "p153", "p159", "p180" & "p197"

diff_z_joy.mod2<- lm(diff_z_joy ~ diff_z_fc_1_o_agr)
coeftest(diff_z_joy.mod2, vcov = vcovHC, type = "HC1")
summary(diff_z_joy.mod2)
confint(diff_z_joy.mod2)
plot(diff_z_joy.mod2)

# joy by fc_2_o_agr
diff_z_joy2.mod <- lm(diff_z_joy ~ diff_z_fc_2_o_agr)
coeftest(diff_z_joy2.mod, vcov = vcovHC, type = "HC1")
summary(diff_z_joy2.mod)
confint(diff_z_joy2.mod)
plot(diff_z_joy2.mod)

# after removing outlier "p053", "p153" & "p197"
diff_z_joy2.mod2 <- lm(diff_z_joy ~ diff_z_fc_2_o_agr)
coeftest(diff_z_joy2.mod2, vcov = vcovHC, type = "HC1")
summary(diff_z_joy2.mod2)
confint(diff_z_joy2.mod2)
plot(diff_z_joy2.mod2)


# eff by fc_1_o_agr
diff_z_eff.mod <- lm(diff_z_eff ~ diff_z_fc_1_o_agr)
coeftest(diff_z_eff.mod, vcov = vcovHC, type = "HC1")
summary(diff_z_eff.mod)
confint(diff_z_eff.mod)
plot(diff_z_eff.mod)

# after removing outlier "p024", "p028", "p049", "p073", "p085", "p136" & "p. "180"
diff_z_eff.mod2 <- lm(diff_z_eff ~ diff_z_fc_1_o_agr)
coeftest(diff_z_eff.mod2, vcov = vcovHC, type = "HC1")
summary(diff_z_eff.mod2)
confint(diff_z_eff.mod2)
plot(diff_z_eff.mod2)

# eff by fc_2_o_agr
diff_z_eff2.mod <- lm(diff_z_eff ~ diff_z_fc_2_o_agr)
coeftest(diff_z_eff2.mod, vcov = vcovHC, type = "HC1")
summary(diff_z_eff2.mod)
confint(diff_z_eff2.mod)
plot(diff_z_eff2.mod)

# after removing outlier "p024" , "p049", "p073", "p085" & "p196"
diff_z_eff2.mod2 <- lm(diff_z_eff ~ diff_z_fc_2_o_agr)
coeftest(diff_z_eff2.mod2, vcov = vcovHC, type = "HC1")
summary(diff_z_eff2.mod2)
confint(diff_z_eff2.mod2)
plot(diff_z_eff2.mod2)

# fixed effect regression fc_2_o_agr, keeping effects across entities constant (step 2)
# joy by fc_1_o_agr
diff_z_joy3 <- plm(z_joy ~ z_fc_1_o_agr + id, 
                   data = US,
                   index = c("id", "time"),
                   model = "within")
coeftest(diff_z_joy3, vcov = vcovHC, type = "HC1")
summary(diff_z_joy3)

# joy by fc_2_o_agr
diff_z_joy4 <- plm(z_joy ~ z_fc_2_o_agr + id, 
                   data = US,
                   index = c("id", "time"),
                   model = "within")
coeftest(diff_z_joy4, vcov = vcovHC, type = "HC1")
summary(diff_z_joy4)

# eff by fc_1_o_agr
diff_z_eff3 <- plm(z_eff ~ z_fc_1_o_agr + id, 
                   data = US,
                   index = c("id", "time"),
                   model = "within")
coeftest(diff_z_eff3, vcov = vcovHC, type = "HC1")
summary(diff_z_eff3)

# eff by fc_2_o_agr
diff_z_eff4 <- plm(z_eff ~ z_fc_2_o_agr + id, 
                   data = US,
                   index = c("id", "time"),
                   model = "within")
coeftest(diff_z_eff4, vcov = vcovHC, type = "HC1")
summary(diff_z_eff4)

# time fixed effect regression fc_2_o_agr, keeping effects across entities and time constant (step 3)
# joy by fc_1_o_agr
diff_z_joy5 <- plm(z_joy ~ z_fc_1_o_agr + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_joy5, vcov = vcovHC, type = "HC1")
summary(diff_z_joy5)

# joy by fc_2_o_agr
diff_z_joy6 <- plm(z_joy ~ z_fc_2_o_agr + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_joy6, vcov = vcovHC, type = "HC1")
summary(diff_z_joy6)

# eff by fc_1_o_agr
diff_z_eff5 <- plm(z_eff ~ z_fc_1_o_agr + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_eff5, vcov = vcovHC, type = "HC1")
summary(diff_z_eff5)

# eff by fc_2_o_agr
diff_z_eff6 <- plm(z_eff ~ z_fc_2_o_agr + id + time,
                    data = US, 
                    index = c("id", "time"),
                    model = "within",
                    effect = "twoways")
coeftest(diff_z_eff6, vcov = vcovHC, type = "HC1")
summary(diff_z_eff6)
```

# False consensus and behavioural intention
```{r}
# Empowerment and behavioural intention 


# Further analyses

```

